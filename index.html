<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>זיהוי מקורות ספריא</title>
    
    <!-- Office.js -->
    <script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js" type="text/javascript"></script>
    
    <style>
        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 15px;
            background: #f5f5f5;
            font-size: 14px;
            direction: rtl;
        }
        
        .container {
            max-width: 100%;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        .header h1 {
            margin: 0;
            font-size: 1.5em;
            font-weight: 300;
        }
        
        .content {
            padding: 20px;
        }
        
        .section {
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 6px;
            border-right: 3px solid #667eea;
        }
        
        .section h3 {
            margin-top: 0;
            color: #2c3e50;
            font-size: 1.1em;
        }
        
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            width: 100%;
            margin: 8px 0;
            transition: all 0.3s ease;
        }
        
        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-secondary {
            background: #6c757d;
        }
        
        .btn-danger {
            background: #dc3545;
        }
        
        .results {
            margin-top: 15px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .source-item {
            background: #e8f5e8;
            margin: 10px 0;
            padding: 12px;
            border-radius: 6px;
            border-right: 3px solid #28a745;
        }
        
        .source-ref {
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 8px;
        }
        
        .source-text {
            font-size: 13px;
            color: #666;
            font-style: italic;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        
        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error {
            background: #ffe6e6;
            border-right: 3px solid #dc3545;
            color: #721c24;
            padding: 12px;
            border-radius: 6px;
            margin: 10px 0;
            font-size: 13px;
        }
        
        .success {
            background: #d4edda;
            border-right: 3px solid #28a745;
            color: #155724;
            padding: 12px;
            border-radius: 6px;
            margin: 10px 0;
            font-size: 13px;
        }
        
        .options {
            margin: 15px 0;
        }
        
        .checkbox-group {
            margin: 10px 0;
        }
        
        .checkbox-group input[type="checkbox"] {
            margin-left: 8px;
        }
        
        .checkbox-group label {
            font-size: 13px;
            color: #555;
        }
        
        .stats {
            background: #fff3cd;
            border-right: 3px solid #ffc107;
            padding: 10px;
            border-radius: 6px;
            margin: 10px 0;
            font-size: 13px;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🔍 זיהוי מקורות</h1>
        </div>
        
        <div class="content">
            <div class="section">
                <h3>פעולות עיקריות</h3>
                <button class="btn" onclick="findSourcesInSelection()">🔍 חפש מקורות בטקסט נבחר</button>
                <button class="btn" onclick="findSourcesInDocument()">📄 חפש מקורות בכל המסמך</button>
                <button class="btn btn-secondary" onclick="clearHighlights()">🧹 נקה הדגשות</button>
            </div>
            
            <div class="section">
                <h3>אפשרויות</h3>
                <div class="options">
                    <div class="checkbox-group">
                        <input type="checkbox" id="addFootnotes" checked>
                        <label for="addFootnotes">הוסף הערות שוליים</label>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="highlightSources" checked>
                        <label for="highlightSources">הדגש מקורות בטקסט</label>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="insertBrackets">
                        <label for="insertBrackets">הוסף מקורות בסוגריים</label>
                    </div>
                </div>
            </div>
            
            <div id="results" style="display: none;">
                <div class="section">
                    <h3>תוצאות</h3>
                    <div id="stats"></div>
                    <div id="sourcesList"></div>
                </div>
            </div>
            
            <div class="section">
                <h3>עזרה</h3>
                <p style="font-size: 13px; color: #666; line-height: 1.4;">
                    בחרו טקסט עברי ולחצו על "חפש מקורות" כדי לזהות מקורות יהודיים. 
                    התוסף יחפש ציטוטים, פסוקים והפניות למקורות ויוסיף אותם למסמך.
                </p>
            </div>
        </div>
    </div>

    <script>
        // Initialize Office.js
        Office.onReady(function(info) {
            console.log('Office.js ready, host:', info.host);
            if (info.host === Office.HostType.Word) {
                console.log('Word host detected');
            }
        });

        // Global variables
        let currentSources = [];
        const SEFARIA_API_URL = 'https://www.sefaria.org/api/find-refs/';

        // Find sources in selected text
        async function findSourcesInSelection() {
            showLoading('מחפש מקורות בטקסט נבחר...');
            
            try {
                await Word.run(async (context) => {
                    const selection = context.document.getSelection();
                    selection.load('text');
                    
                    await context.sync();
                    
                    if (!selection.text.trim()) {
                        showError('אנא בחרו טקסט לחיפוש מקורות');
                        return;
                    }
                    
                    const sources = await callSefariaAPI(selection.text);
                    await processSources(context, sources, selection.text, 'selection');
                });
            } catch (error) {
                console.error('Error finding sources in selection:', error);
                showError('שגיאה בחיפוש מקורות: ' + error.message);
            }
        }

        // Find sources in entire document
        async function findSourcesInDocument() {
            showLoading('מחפש מקורות בכל המסמך...');
            
            try {
                await Word.run(async (context) => {
                    const body = context.document.body;
                    body.load('text');
                    
                    await context.sync();
                    
                    if (!body.text.trim()) {
                        showError('המסמך ריק');
                        return;
                    }
                    
                    const sources = await callSefariaAPI(body.text);
                    await processSources(context, sources, body.text, 'document');
                });
            } catch (error) {
                console.error('Error finding sources in document:', error);
                showError('שגיאה בחיפוש מקורות: ' + error.message);
            }
        }

        // Call Sefaria API
        async function callSefariaAPI(text) {
            try {
                const response = await fetch(SEFARIA_API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        text: {
                            body: text,
                            title: ""
                        },
                        lang: "he"
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                return await response.json();
            } catch (error) {
                console.error('API Error:', error);
                throw new Error('לא ניתן להתחבר לשרת ספריא. בדקו את החיבור לאינטרנט.');
            }
        }

        // Process sources and update document
        async function processSources(context, apiResponse, originalText, scope) {
            const bodyResults = apiResponse.body?.results || [];
            const titleResults = apiResponse.title?.results || [];
            const allResults = [...bodyResults, ...titleResults];
            
            currentSources = allResults;
            
            if (allResults.length === 0) {
                showSuccess('לא נמצאו מקורות בטקסט זה');
                return;
            }
            
            // Apply user preferences
            const addFootnotes = document.getElementById('addFootnotes').checked;
            const highlightSources = document.getElementById('highlightSources').checked;
            const insertBrackets = document.getElementById('insertBrackets').checked;
            
            try {
                if (scope === 'selection') {
                    const selection = context.document.getSelection();
                    await applySourcesToRange(context, selection, allResults, apiResponse, {
                        addFootnotes, highlightSources, insertBrackets
                    });
                } else {
                    const body = context.document.body;
                    await applySourcesToRange(context, body, allResults, apiResponse, {
                        addFootnotes, highlightSources, insertBrackets
                    });
                }
                
                await context.sync();
                showResults(allResults, apiResponse);
                showSuccess(`נמצאו ${allResults.length} מקורות ועודכן המסמך`);
                
            } catch (error) {
                console.error('Error applying sources:', error);
                showError('שגיאה בעדכון המסמך: ' + error.message);
            }
        }

        // Apply sources to a range
        async function applySourcesToRange(context, range, results, apiResponse, options) {
            // Sort results by position (descending to avoid offset issues)
            const sortedResults = results.sort((a, b) => b.startChar - a.startChar);
            
            for (const result of sortedResults) {
                try {
                    // Find the text range for this result
                    const searchResults = range.search(result.text);
                    context.load(searchResults, 'items');
                    await context.sync();
                    
                    if (searchResults.items.length > 0) {
                        const foundRange = searchResults.items[0];
                        
                        // Highlight source
                        if (options.highlightSources) {
                            foundRange.font.highlightColor = '#FFFF00';
                            foundRange.font.bold = true;
                        }
                        
                        // Add footnote
                        if (options.addFootnotes) {
                            const footnoteText = result.refs.map(ref => {
                                const refData = apiResponse.body?.refData?.[ref] || apiResponse.title?.refData?.[ref];
                                return refData ? refData.heRef : ref;
                            }).join(', ');
                            
                            foundRange.insertFootnote(footnoteText);
                        }
                        
                        // Insert brackets with source
                        if (options.insertBrackets) {
                            const heRefs = result.refs.map(ref => {
                                const refData = apiResponse.body?.refData?.[ref] || apiResponse.title?.refData?.[ref];
                                return refData ? refData.heRef : ref;
                            }).join(', ');
                            
                            foundRange.insertText(` [${heRefs}]`, Word.InsertLocation.after);
                        }
                    }
                } catch (error) {
                    console.error('Error processing individual result:', error);
                }
            }
        }

        // Clear highlights
        async function clearHighlights() {
            try {
                await Word.run(async (context) => {
                    const body = context.document.body;
                    const searchResults = body.search('', {matchWildcards: false});
                    context.load(searchResults, 'items');
                    
                    await context.sync();
                    
                    // Clear all highlighting
                    for (let i = 0; i < searchResults.items.length; i++) {
                        searchResults.items[i].font.highlightColor = null;
                        searchResults.items[i].font.bold = false;
                    }
                    
                    await context.sync();
                    showSuccess('הדגשות נוקו');
                });
            } catch (error) {
                console.error('Error clearing highlights:', error);
                showError('שגיאה בניקוי הדגשות: ' + error.message);
            }
        }

        // Show results
        function showResults(results, apiResponse) {
            const resultsDiv = document.getElementById('results');
            const statsDiv = document.getElementById('stats');
            const sourcesListDiv = document.getElementById('sourcesList');
            
            // Show stats
            const uniqueBooks = new Set(results.map(r => r.refs[0]?.split(' ')[0])).size;
            statsDiv.innerHTML = `
                <div class="stats">
                    📊 נמצאו ${results.length} מקורות מ-${uniqueBooks} ספרים שונים
                </div>
            `;
            
            // Group sources by reference
            const groupedSources = {};
            results.forEach(result => {
                result.refs.forEach(ref => {
                    if (!groupedSources[ref]) {
                        const refData = apiResponse.body?.refData?.[ref] || apiResponse.title?.refData?.[ref];
                        groupedSources[ref] = {
                            ref: ref,
                            heRef: refData?.heRef || ref,
                            url: refData?.url || '',
                            category: refData?.primaryCategory || '',
                            matches: []
                        };
                    }
                    groupedSources[ref].matches.push(result.text);
                });
            });
            
            // Display sources
            let htmlContent = '';
            Object.values(groupedSources).forEach(source => {
                htmlContent += `
                    <div class="source-item">
                        <div class="source-ref">
                            📖 ${source.heRef}
                            ${source.category ? `<span style="color: #666; font-size: 0.9em;"> (${source.category})</span>` : ''}
                        </div>
                        <div class="source-text">
                            טקסט: "${source.matches.join('", "')}"
                        </div>
                    </div>
                `;
            });
            
            sourcesListDiv.innerHTML = htmlContent;
            resultsDiv.style.display = 'block';
        }

        // UI Helper functions
        function showLoading(message) {
            const resultsDiv = document.getElementById('results');
            const sourcesListDiv = document.getElementById('sourcesList');
            
            sourcesListDiv.innerHTML = `
                <div class="loading">
                    ${message}
                    <div class="spinner"></div>
                </div>
            `;
            resultsDiv.style.display = 'block';
        }

        function showError(message) {
            const resultsDiv = document.getElementById('results');
            const sourcesListDiv = document.getElementById('sourcesList');
            
            sourcesListDiv.innerHTML = `
                <div class="error">
                    <strong>שגיאה:</strong> ${message}
                </div>
            `;
            resultsDiv.style.display = 'block';
        }

        function showSuccess(message) {
            const resultsDiv = document.getElementById('results');
            const sourcesListDiv = document.getElementById('sourcesList');
            
            // Add success message at the top
            const existingContent = sourcesListDiv.innerHTML;
            sourcesListDiv.innerHTML = `
                <div class="success">
                    ✅ ${message}
                </div>
                ${existingContent}
            `;
            resultsDiv.style.display = 'block';
        }
    </script>
</body>
</html>